<!doctype html>
<html lang="th">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0b0b">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Emoji RPG ‚Äî Full</title>
<style>
  :root{--w:380px}
  body{background:#0b0b0b;color:#fff;font-family:Inter,Arial;text-align:center;margin:0;padding:14px}
  .wrap{max-width:var(--w);margin:0 auto}
  #game{width:var(--w);height:240px;margin:10px auto;border-radius:12px;position:relative;overflow:hidden;border:2px solid #222;touch-action:manipulation}
  .hero,.monster,.npc{position:absolute;transition:left .22s,transform .12s;user-select:none}
  .hero{left:36px;bottom:22px;font-size:52px;transform-origin:center}
  .monster{right:36px;font-size:20px;height:100px;width:120px;text-align:center}
  .monster-emoji{position:absolute;left:50%;transform:translateX(-50%);bottom:34px;font-size:52px;pointer-events:none}
  .monster-badge{position:absolute;left:50%;transform:translateX(-50%);bottom:86px;font-size:14px;background:transparent;padding:2px 6px;border-radius:6px}
  .npc{left:150px;bottom:64px;font-size:36px;cursor:pointer}
  .npcLabel{position:absolute;left:120px;bottom:108px;font-size:12px;background:rgba(0,0,0,.55);padding:4px 6px;border-radius:6px;pointer-events:none}
  .hpbar{width:88%;height:14px;background:#333;margin:8px auto;border-radius:10px;overflow:hidden}
  .hp{height:100%;background:linear-gradient(90deg,#ff5252,#b30000);width:100%}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px auto}
  button{padding:8px 10px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .atk{background:#ff9800;color:#000}
  .ult{background:#e91e63}
  .heal{background:#4caf50;color:#000}
  .shop{background:#2196f3}
  .petbox{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:8px}
  .slot{width:56px;height:56px;background:#333;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer}
  .slot.secret{background:#111;color:#ddd;border:2px solid #fff}
  .slot.common{color:#4caf50}
  .slot.epic{color:#9b59b6}
  .slot.legend{color:#f1c40f}
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.8);z-index:60}
  .modal .box{width:340px;background:#171717;padding:12px;border-radius:12px;text-align:center;max-height:82vh;overflow:auto;box-sizing:border-box}
  .eggs{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:8px 0;max-height:220px;overflow:auto;padding:6px}
  .egg{width:44px;height:64px;background:linear-gradient(180deg,#bfbfbf,#8f8f8f);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:22px;color:#222;position:relative;overflow:hidden;box-shadow:0 6px 12px rgba(0,0,0,.6);margin:4px;transform-origin:center}
  .dmg{position:absolute;font-weight:900;color:#ffb3b3;text-shadow:0 0 8px #000;font-size:18px;pointer-events:none;z-index:70}
  .winBox{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);background:rgba(0,0,0,.85);padding:18px;border-radius:12px;font-size:20px;display:none;z-index:200;text-align:center}
  .small{font-size:12px;color:#bbb}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#222;padding:8px 12px;border-radius:12px;display:none;z-index:120}

  /* Egg sway animation */
  .egg.sway{ animation: sway 0.9s ease-in-out infinite; }
  @keyframes sway {0%{transform:rotate(-6deg);}50%{transform:rotate(6deg);}100%{transform:rotate(-6deg);}}
  .egg.crack{ animation: crack 0.28s ease forwards; }
  @keyframes crack {0%{transform:scale(1) rotate(0deg);}50%{transform:scale(0.95) rotate(8deg);}100%{transform:scale(1) rotate(0deg);}}
  .egg.revealed{ background:linear-gradient(180deg,#fff,#ddd); font-size:28px; color:#000; }

  /* hero attack move */
  .move-attack{ animation: hero-attack 0.7s ease; }
  @keyframes hero-attack {0%{transform:translateX(0);}40%{transform:translateX(120px);}100%{transform:translateX(0);}}
  .move-mattack{ animation: monster-hit 0.3s ease; }
  @keyframes monster-hit {0%{transform:translateX(0);}50%{transform:translateX(-8px);}100%{transform:translateX(0);}}

  /* pet sprite in game */
  .pet-sprite{ position:absolute; font-size:34px; transition:left .2s, transform .12s; pointer-events:none; z-index:50 }
  .pet-attack{ animation: pet-attack 0.7s ease; }
  @keyframes pet-attack {0%{transform:translateX(0);}40%{transform:translateX(120px);}100%{transform:translateX(0);}}

  /* zones */
  .zone-1{ background: linear-gradient(180deg,#1f1f1f,#131313); }
  .zone-2{ background: linear-gradient(180deg,#2b1b3a,#16091a); }
  .zone-3{ background: linear-gradient(180deg,#2a1d0b,#120904); }
  .zone-4{ background: linear-gradient(180deg,#1b2a1b,#071007); }
</style>
</head>
<body>
<div class="wrap">
  <h1>Emoji RPG ‚Äî Full</h1>
  <div>
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span id="modeLabel">Lobby</span>  &nbsp;|&nbsp; ‡πÄ‡∏á‡∏¥‡∏ô: <span id="goldLabel">20</span>
    &nbsp;|&nbsp; ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: <span id="playerCodeLabel" class="small">-</span>
  </div>

  <div id="game" class="zone-1" aria-label="game area">
    <div id="hero" class="hero">ü§∫</div>
    <div id="monster" class="monster"><div class="monster-emoji"></div><div class="monster-badge"></div></div>
    <div id="npc" class="npc" title="‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå" tabindex="0">üï¥Ô∏è</div>
    <div id="npcLabel" class="npcLabel">‡∏™‡∏∏‡πà‡∏°‡∏™‡∏±‡∏ï‡∏ß‡πå</div>
  </div>

  <div class="hpbar"><div id="playerHPbar" class="hp"></div></div>
  <div id="playerHPtext" class="small"></div>

  <div class="hpbar"><div id="monsterHPbar" class="hp"></div></div>
  <div id="monsterHPtext" class="small"></div>

  <div style="margin-top:8px;text-align:left">
    <div class="small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πà‡∏ß‡∏ô:</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <div class="small">üîπ ‡πÑ‡∏Ç‡πà‡∏™‡∏∏‡πà‡∏°: <span id="eggsOpened">0</span></div>
      <div class="small">üîπ ‡∏û‡∏•‡∏±‡∏á: <span id="statPower">5</span></div>
      <div class="small">üîπ MaxHP: <span id="statMaxHP">120</span></div>
      <div class="small">üîπ ‡∏ä‡πà‡∏≠‡∏á Active: <span id="activeSlotCount">2</span></div>
      <div class="small">üîπ ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalPets">0</span></div>
      <div class="small">üîπ Rebirth: <span id="rebirthCount">0</span></div>
      <div class="small">üîπ ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡πÄ‡∏á‡∏¥‡∏ô: x<span id="rebirthMultiplier">1</span></div>
      <div class="small">üîπ Best Wave (Inf): <span id="bestWave">0</span></div>
    </div>
  </div>

  <!-- Lobby UI -->
  <div id="lobbyUI">
    <div class="controls">
      <button id="openEggBtn" class="shop">‡∏Ñ‡∏∏‡∏¢‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏Ç‡πà)</button>
      <button id="startBtn" class="shop">‚ñ∂Ô∏è ‡∏≠‡∏≠‡∏Å‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢</button>
      <button id="infinityBtn" class="shop">‚àû ‡πÇ‡∏´‡∏°‡∏î Infinity</button>
      <button id="equipBestBtn" class="shop">‚≠ê Equip Best</button>
    </div>

    <div class="controls">
      <button id="buyPowerBtn" class="shop">‚öîÔ∏è ‡∏≠‡∏±‡∏û‡∏û‡∏•‡∏±‡∏á</button>
      <button id="buyPower10Btn" class="shop">‚öîÔ∏è x10</button>
      <button id="buyPower100Btn" class="shop">‚öîÔ∏è x100</button>
      <button id="buyPower1000Btn" class="shop">‚öîÔ∏è x1000</button>
      <button id="buyPower10000Btn" class="shop">‚öîÔ∏è x10000</button>
    </div>

    <div class="controls">
      <button id="buyHPBtn" class="shop">‚ù§Ô∏è ‡∏≠‡∏±‡∏û‡πÄ‡∏•‡∏∑‡∏≠‡∏î</button>
      <button id="buyHP10Btn" class="shop">‚ù§Ô∏è x10</button>
      <button id="buyHP100Btn" class="shop">‚ù§Ô∏è x100</button>
    </div>

    <div class="controls">
      <button id="buyPetSlotBtn" class="shop">‡∏ã‡∏∑‡πâ‡∏≠‡∏ä‡πà‡∏≠‡∏á Active (+1) (50,000)</button>
      <button id="autoSellBtn" class="shop">‡∏Ç‡∏≤‡∏¢ Common ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
      <button id="autoSellEpicBtn" class="shop">‡∏Ç‡∏≤‡∏¢ Epic ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
    </div>

    <div class="controls">
      <button id="rebirthBtn" class="shop">Rebirth (1,000,000)</button>
      <button id="logoutBtn" class="shop">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div style="margin-top:8px">
      <div><b>Active Pets (<span id="activePetsCountDisplay">2</span>)</b></div>
      <div id="activePets" class="petbox"></div>
      <hr style="border-color:#222"/>
      <div><b>Bag ‚Äî Common</b></div>
      <div id="bagCommon" class="petbox"></div>
      <div><b>Bag ‚Äî Epic</b></div>
      <div id="bagEpic" class="petbox"></div>
      <div><b>Bag ‚Äî Legendary</b></div>
      <div id="bagLegend" class="petbox"></div>
      <div><b>Bag ‚Äî Secret</b></div>
      <div id="bagSecret" class="petbox"></div>
    </div>
  </div>

  <!-- Adventure UI -->
  <div id="advUI" style="display:none" class="controls">
    <button id="atkBtn" class="atk">‡πÇ‡∏à‡∏°‡∏ï‡∏µ</button>
    <button id="ultBtn" class="ult">‡∏≠‡∏±‡∏•‡∏ï‡∏¥</button>
    <button id="healBtn" class="heal">‡∏Æ‡∏µ‡∏• 25%</button>
    <button id="surrenderBtn" class="shop" style="display:none">‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ (Infinity)</button>
  </div>

</div>

<!-- Egg modal -->
<div class="modal" id="eggModal">
  <div class="box">
    <h3>‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏Ç‡πà</h3>
    <p class="small">‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏Ç‡πà‡∏•‡∏∞ 500</p>
    <div style="margin:8px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center">
      <button onclick="buyEggs(1)">‡∏™‡∏∏‡πà‡∏° 1</button>
      <button onclick="buyEggs(3)">‡∏™‡∏∏‡πà‡∏° 3</button>
      <button onclick="buyEggs(10)">‡∏™‡∏∏‡πà‡∏° 10</button>
      <button id="buyEgg100Btn">‡∏™‡∏∏‡πà‡∏° 100</button>
      <button id="buyEgg1000Btn">‡∏™‡∏∏‡πà‡∏° 1000</button>
      <button onclick="skipEggs()">‡∏Ç‡πâ‡∏≤‡∏°</button>
      <button onclick="closeEggModal()">‡∏õ‡∏¥‡∏î</button>
    </div>
    <div class="small" id="dropRatesArea" style="margin-top:8px"></div>
    <div class="eggs" id="eggsArea"></div>
  </div>
</div>

<!-- Auth Modal -->
<div class="modal" id="authModal">
  <div class="box">
    <h3 id="authTitle">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö / ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
    <div style="text-align:left;margin-top:8px">
      <label class="small">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠):</label><br/>
      <input id="authCodeInput" style="width:90%;padding:8px;border-radius:8px;border:none;margin-top:6px"/><br/>
      <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
        <button id="authLoginBtn" class="shop">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
        <button id="authRegisterBtn" class="shop">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
      </div>
      <div style="margin-top:10px" class="small">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
    </div>
  </div>
</div>

<div class="winBox" id="winBox"></div>
<div class="toast" id="toast"></div>

<script>
// Global error catcher to surface runtime errors quickly
window.onerror = function(message, source, lineno, colno, error) {
  console.error('Global error:', message, source, lineno, colno, error);
  try { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + message); } catch(e){}
};

document.addEventListener('DOMContentLoaded', ()=>{

/* -----------------------------
   State & Config
   ----------------------------- */
let mode = 'lobby'; // 'lobby' | 'adventure'
let gold = 20;
let power = 5;
let maxHP = 120;
let playerHP = maxHP;
let stage = 0;

let monsterMaxHP = 0, monsterHP = 0, monsterAtk = 0, isBoss = false;
let atkReady = true, ultReady = true, healReady = true;

const MONSTER_HP_SCALE = 0.85;
const NORMAL_REWARD_MULT = 50;
const BOSS_REWARD_MULT = 150;

// Drop table with explicit probabilities (percent)
const petDefs = [
  {id:'dog',emoji:'üêï',tier:'Common',pct:0.23725,price:300,prob:23.725},
  {id:'chicken',emoji:'üêì',tier:'Common',pct:0.23725,price:300,prob:23.725},
  {id:'monkey',emoji:'üêí',tier:'Common',pct:0.23725,price:300,prob:23.725},
  {id:'cat',emoji:'üêà‚Äç‚¨õ',tier:'Common',pct:0.23725,price:300,prob:23.725},
  {id:'mammoth',emoji:'ü¶£',tier:'Epic',pct:0.70,price:900,prob:2.45},
  {id:'gorilla',emoji:'ü¶ç',tier:'Epic',pct:0.75,price:900,prob:2.45},
  {id:'dragon',emoji:'üêâ',tier:'Legendary',pct:1.75,price:4000,prob:0.095},
  {id:'secretrex',emoji:'ü¶ñ',tier:'Secret',pct:5.0,price:20000,prob:0.005} // 0.005%
];

let bag = []; // {typeId,emoji,pct,tier,price,lvl}
let activeSlots = 2;
let maxActiveSlots = 4;
let active = new Array(activeSlots).fill(null);

let petSlotPrice = 50000;
const petSlotIncrement = 100000;

// Rebirth / Infinity
let rebirthCount = 0;
let rebirthCost = 1000000;
let rebirthMultiplier = 1;
let eggsOpened = 0;
let infinityMode = false;
let infinityWave = 0;
let bestWave = 0;

const monsterPool = [
  {emoji:'üëæ', baseHP:80, baseAtk:8},
  {emoji:'üëπ', baseHP:120, baseAtk:10},
  {emoji:'üë∫', baseHP:100, baseAtk:9},
  {emoji:'ü¶¥', baseHP:140, baseAtk:12},
  {emoji:'üï∑Ô∏è', baseHP:90, baseAtk:11},
  {emoji:'ü¶Ç', baseHP:110, baseAtk:13},
  {emoji:'üêç', baseHP:95, baseAtk:10},
  {emoji:'üßü', baseHP:130, baseAtk:12},
  {emoji:'ü™≤', baseHP:85, baseAtk:9},
  {emoji:'üëª', baseHP:150, baseAtk:14},
  {emoji:'üíÄ', baseHP:160, baseAtk:15},
  {emoji:'üêâ', baseHP:220, baseAtk:18},
  {emoji:'ü¶à', baseHP:170, baseAtk:16},
  {emoji:'ü¶Å', baseHP:130, baseAtk:14},
  {emoji:'ü¶Ñ', baseHP:200, baseAtk:17},
  {emoji:'ü§ñ', baseHP:180, baseAtk:16},
  {emoji:'üê∫', baseHP:110, baseAtk:11}
];

/* -----------------------------
   DOM refs
   ----------------------------- */
const modeLabel = document.getElementById('modeLabel');
const goldLabel = document.getElementById('goldLabel');
const hero = document.getElementById('hero');
const game = document.getElementById('game');
const npc = document.getElementById('npc');
const npcLabel = document.getElementById('npcLabel');
const playerHPbar = document.getElementById('playerHPbar');
const playerHPtext = document.getElementById('playerHPtext');
const monsterEl = document.getElementById('monster');
const monsterEmojiEl = monsterEl.querySelector('.monster-emoji');
const monsterBadgeEl = monsterEl.querySelector('.monster-badge');
const monsterHPbar = document.getElementById('monsterHPbar');
const monsterHPtext = document.getElementById('monsterHPtext');
const lobbyUI = document.getElementById('lobbyUI');
const advUI = document.getElementById('advUI');
const openEggBtn = document.getElementById('openEggBtn');
const startBtn = document.getElementById('startBtn');
const equipBestBtn = document.getElementById('equipBestBtn');
const buyPowerBtn = document.getElementById('buyPowerBtn');
const buyPower10Btn = document.getElementById('buyPower10Btn');
const buyPower100Btn = document.getElementById('buyPower100Btn');
const buyPower1000Btn = document.getElementById('buyPower1000Btn');
const buyPower10000Btn = document.getElementById('buyPower10000Btn');
const buyHPBtn = document.getElementById('buyHPBtn');
const buyHP10Btn = document.getElementById('buyHP10Btn');
const buyHP100Btn = document.getElementById('buyHP100Btn');
const buyPetSlotBtn = document.getElementById('buyPetSlotBtn');
const autoSellBtn = document.getElementById('autoSellBtn');
const autoSellEpicBtn = document.getElementById('autoSellEpicBtn');
const rebirthBtn = document.getElementById('rebirthBtn');
const infinityBtn = document.getElementById('infinityBtn');

const atkBtn = document.getElementById('atkBtn');
const ultBtn = document.getElementById('ultBtn');
const healBtn = document.getElementById('healBtn');
const surrenderBtn = document.getElementById('surrenderBtn');

const eggModal = document.getElementById('eggModal');
const eggsArea = document.getElementById('eggsArea');
const bagCommon = document.getElementById('bagCommon');
const bagEpic = document.getElementById('bagEpic');
const bagLegend = document.getElementById('bagLegend');
const bagSecret = document.getElementById('bagSecret');
const activePetsDiv = document.getElementById('activePets');
const winBox = document.getElementById('winBox');
const toast = document.getElementById('toast');

const eggsOpenedEl = document.getElementById('eggsOpened');
const statPowerEl = document.getElementById('statPower');
const statMaxHPEl = document.getElementById('statMaxHP');
const activeSlotCountEl = document.getElementById('activeSlotCount');
const totalPetsEl = document.getElementById('totalPets');
const playerCodeLabel = document.getElementById('playerCodeLabel');
const activePetsCountDisplay = document.getElementById('activePetsCountDisplay');
const rebirthCountEl = document.getElementById('rebirthCount');
const rebirthMultiplierEl = document.getElementById('rebirthMultiplier');
const bestWaveEl = document.getElementById('bestWave');

/* -----------------------------
   Auth refs
   ----------------------------- */
const authModal = document.getElementById('authModal');
const authCodeInput = document.getElementById('authCodeInput');
const authLoginBtn = document.getElementById('authLoginBtn');
const authRegisterBtn = document.getElementById('authRegisterBtn');
let currentPlayerCode = null;

/* -----------------------------
   Helpers
   ----------------------------- */
function showToast(txt){
  toast.innerText = txt;
  toast.style.display = 'block';
  setTimeout(()=>toast.style.display='none',1400);
}
function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function formatNumber(n){ return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }

/* -----------------------------
   Save / Load (by code)
   ----------------------------- */
function saveKey(code){ return `emoji_save_${code}`; }
function saveGame(){
  if(!currentPlayerCode) return;
  const data = {
    gold, power, maxHP, playerHP, stage,
    bag, activeSlots, active, petSlotPrice,
    eggsOpened, rebirthCount, rebirthMultiplier, rebirthCost, bestWave
  };
  try {
    localStorage.setItem(saveKey(currentPlayerCode), JSON.stringify(data));
  } catch(e) { console.error('saveGame error', e); }
}
function loadGame(code){
  const raw = localStorage.getItem(saveKey(code));
  if(!raw) return false;
  try{
    const d = JSON.parse(raw);
    gold = d.gold || 20;
    power = d.power || 5;
    maxHP = d.maxHP || 120;
    playerHP = d.playerHP || maxHP;
    stage = d.stage || 0;
    bag = d.bag || [];
    activeSlots = d.activeSlots || 2;
    active = d.active || new Array(activeSlots).fill(null);
    petSlotPrice = d.petSlotPrice || petSlotPrice;
    eggsOpened = d.eggsOpened || 0;
    rebirthCount = d.rebirthCount || 0;
    rebirthMultiplier = d.rebirthMultiplier || 1;
    rebirthCost = d.rebirthCost || rebirthCost;
    bestWave = d.bestWave || 0;
    return true;
  }catch(e){ console.error('loadGame parse error', e); return false; }
}
function clearSave(code){ localStorage.removeItem(saveKey(code)); }

/* -----------------------------
   UI update
   ----------------------------- */
function updateUI(){
  modeLabel.innerText = mode === 'lobby' ? 'Lobby' : `Stage ${stage}`;
  goldLabel.innerText = formatNumber(gold);
  playerHPbar.style.width = Math.max(0, Math.floor(playerHP/maxHP*100)) + '%';
  playerHPtext.innerText = `${playerHP}/${maxHP}`;
  if(monsterMaxHP > 0){
    monsterHPbar.style.width = Math.max(0, Math.floor(monsterHP/monsterMaxHP*100)) + '%';
    monsterHPtext.innerText = `${monsterHP}/${monsterMaxHP}` + (isBoss ? `  ‚è± ${bossTime}s` : '');
  } else {
    monsterHPbar.style.width = '0%';
    monsterHPtext.innerText = '';
  }

  lobbyUI.style.display = (mode === 'lobby') ? 'block' : 'none';
  advUI.style.display = (mode === 'adventure') ? 'flex' : 'none';
  if(mode === 'lobby'){ npc.style.display = 'block'; npcLabel.style.display = 'block'; openEggBtn.disabled = false; }
  else { npc.style.display = 'none'; npcLabel.style.display = 'none'; openEggBtn.disabled = true; }

  eggsOpenedEl.innerText = eggsOpened;
  statPowerEl && (statPowerEl.innerText = power);
  statMaxHPEl && (statMaxHPEl.innerText = maxHP);
  activeSlotCountEl.innerText = activeSlots;
  totalPetsEl.innerText = bag.length;
  playerCodeLabel.innerText = currentPlayerCode ? currentPlayerCode : '-';
  activePetsCountDisplay.innerText = activeSlots;
  rebirthCountEl.innerText = rebirthCount;
  rebirthMultiplierEl.innerText = rebirthMultiplier;
  bestWaveEl.innerText = bestWave;

  renderPets(); renderActiveSprites();
  saveGame();
}

/* -----------------------------
   Movement in Lobby (click/tap)
   ----------------------------- */
game.addEventListener('click', (e)=>{
  if(mode !== 'lobby') return;
  const rect = game.getBoundingClientRect();
  const clientX = e.clientX !== undefined ? e.clientX : (e.touches && e.touches[0].clientX);
  const x = clientX - rect.left;
  const left = Math.max(8, Math.min(x-20, rect.width - 60));
  hero.style.left = left + 'px';
});

/* -----------------------------
   NPC egg modal
   ----------------------------- */
npc.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(mode !== 'lobby'){ showToast('‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Lobby ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
  openEggModal();
});
openEggBtn.addEventListener('click', (e)=>{ e.preventDefault(); if(mode !== 'lobby'){ showToast('‡∏û‡πà‡∏≠‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà Lobby ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; } openEggModal(); });

function openEggModal(){ eggModal.style.display = 'flex'; eggsArea.innerHTML = ''; eggSkip = false; renderDropRates(); }
function closeEggModal(){ eggModal.style.display = 'none'; }

/* -----------------------------
   Pets UI (render, sell, equip)
   ----------------------------- */
function renderPets(){
  bagCommon.innerHTML = ''; bagEpic.innerHTML = ''; bagLegend.innerHTML = ''; bagSecret.innerHTML = ''; activePetsDiv.innerHTML = '';
  // sanitize active indices (if bag changed)
  for(let i=0;i<active.length;i++){
    if(active[i] != null && (active[i] < 0 || active[i] >= bag.length)) active[i] = null;
  }

  bag.forEach((p, idx) => {
    const el = document.createElement('div');
    el.className = 'slot ' + (p.tier==='Secret'?'secret': p.tier==='Common'?'common': p.tier==='Epic'?'epic': p.tier==='Legendary'?'legend':'');
    el.innerText = p.emoji + (p.lvl > 1 ? ('+'+p.lvl) : '');
    el.title = `${p.tier}\nDMG ${Math.round(p.pct*100)}%\n‡∏Ç‡∏≤‡∏¢ ${p.price}`;
    el.addEventListener('click', ()=>{
      const sell = confirm(`‡∏™‡∏±‡∏ï‡∏ß‡πå ${p.emoji}\n‡∏£‡∏∞‡∏î‡∏±‡∏ö ${p.tier}\n‡∏î‡∏≤‡πÄ‡∏°‡∏à ${Math.round(p.pct*100)}%\n‡∏Å‡∏î ‡∏ï‡∏Å‡∏•‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≤‡∏¢ ‡∏£‡∏±‡∏ö ${p.price}\n‡∏Å‡∏î ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà Active`);
      if(sell){
        removeBagIndex(idx);
        gold += p.price;
        showToast('‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        updateUI();
      } else {
        toggleEquip(idx);
      }
    });
    if(p.tier === 'Common') bagCommon.appendChild(el);
    else if(p.tier === 'Epic') bagEpic.appendChild(el);
    else if(p.tier === 'Legendary') bagLegend.appendChild(el);
    else if(p.tier === 'Secret') bagSecret.appendChild(el);
  });

  for(let i=0;i<activeSlots;i++){
    const s = document.createElement('div');
    s.className = 'slot';
    if(active[i] != null && bag[active[i]]) s.innerText = bag[active[i]].emoji + (bag[active[i]].lvl>1?('+'+bag[active[i]].lvl):'');
    s.addEventListener('click', ()=>{
      if(active[i] != null){ active[i] = null; updateUI(); }
      else showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏™‡πà‡∏ä‡πà‡∏≠‡∏á');
    });
    activePetsDiv.appendChild(s);
  }
}

function removeBagIndex(idx){
  bag.splice(idx,1);
  for(let j=0;j<active.length;j++){
    if(active[j] == null) continue;
    if(active[j] == idx) active[j] = null;
    else if(active[j] > idx) active[j]--;
  }
}

function toggleEquip(bagIndex){
  const found = active.indexOf(bagIndex);
  if(found !== -1){ active[found] = null; updateUI(); return; }
  const free = active.indexOf(null);
  if(free === -1){ showToast('‡∏ä‡πà‡∏≠‡∏á Active ‡πÄ‡∏ï‡πá‡∏° ('+activeSlots+')'); return; }
  active[free] = bagIndex;
  updateUI();
}

function equipBest(){
  const arr = bag.map((p,i)=>({p,i})).sort((a,b)=>b.p.pct - a.p.pct);
  active = new Array(activeSlots).fill(null);
  for(let i=0;i<activeSlots && i < arr.length; i++) active[i] = arr[i].i;
  updateUI();
}
equipBestBtn.addEventListener('click', ()=>{
  if(mode !== 'lobby'){ showToast('‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà Lobby ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
  equipBest();
});

/* -----------------------------
   Eggs (modal + reveal) with sway animation
   ----------------------------- */
let eggSkip = false;
async function buyEggs(n){
  try{
    const cost = 500 * n;
    if(gold < cost){ showToast('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
    gold -= cost; eggsOpened += n; updateUI();
    eggsArea.innerHTML = ''; eggSkip = false;
    // create egg elements
    const items = [];
    for(let i=0;i<n;i++){
      const el = document.createElement('div'); el.className = 'egg sway'; el.innerHTML = '<div>ü•ö</div>';
      eggsArea.appendChild(el); items.push(el);
    }
    // reveal with short delay (fast enough to avoid long blocking)
    for(const el of items){
      if(eggSkip){ revealEgg(el); continue; }
      el.classList.add('crack'); await wait(150);
      revealEgg(el);
      await wait(10);
    }
    setTimeout(()=>{ eggModal.style.display = 'none'; }, 400);
  } catch(e){ console.error('buyEggs error', e); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏Ç‡πà'); }
}
function skipEggs(){ eggSkip = true; const all = [...eggsArea.querySelectorAll('.egg')]; all.forEach(revealEgg); }
function revealEgg(el){
  if(el.dataset.r) return; el.dataset.r = '1';
  el.classList.remove('sway'); el.classList.remove('crack');
  // pick by probability table
  const total = petDefs.reduce((s,p)=>s+p.prob,0);
  let r = Math.random()*total;
  for(const p of petDefs){
    if(r < p.prob){
      bag.push({typeId:p.id,emoji:p.emoji,pct:p.pct,tier:p.tier,price:p.price,lvl:1});
      el.classList.add('revealed');
      el.innerHTML = `<div style="font-size:34px">${p.emoji}</div>`;
      showToast(`‡πÑ‡∏î‡πâ ${p.tier} ${p.emoji}`);
      break;
    }
    r -= p.prob;
  }
  updateUI();
}

// quick buttons
const buyEgg100Btn = document.getElementById('buyEgg100Btn');
const buyEgg1000Btn = document.getElementById('buyEgg1000Btn');
buyEgg100Btn.addEventListener('click', ()=> buyEggs(100));
buyEgg1000Btn.addEventListener('click', ()=> buyEggs(1000));

function renderDropRates(){
  const total = petDefs.reduce((s,p)=>s+p.prob,0);
  let html = '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏≠‡∏≠‡∏Å: ';
  petDefs.forEach(p=>{
    const pct = Math.round((p.prob/total)*100000)/1000; // show with 3 decimals when needed
    html += `<span style="margin-right:8px">${p.tier} ${p.emoji}: ${pct}%</span>`;
  });
  document.getElementById('dropRatesArea').innerHTML = html;
}

/* -----------------------------
   Start adventure / spawn / enter lobby
   ----------------------------- */
startBtn.addEventListener('click', ()=> {
  if(!currentPlayerCode){ showToast('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); openAuth(); return; }
  if(mode !== 'lobby'){ showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏≠‡∏¢‡∏π‡πà'); return; }
  startAdventure();
});

function startAdventure(){
  mode = 'adventure';
  stage++;
  spawnMonster();
  startLoops();
  startRegen();
  updateUI();
}

function enterLobby(){
  mode = 'lobby';
  stopLoops();
  stopRegen();
  monsterEmojiEl.innerText = '';
  monsterBadgeEl.innerText = '';
  monsterMaxHP = 0; monsterHP = 0; monsterAtk = 0; isBoss = false;
  infinityMode = false;
  surrenderBtn.style.display = 'none';
  updateUI();
}

/* -----------------------------
   Zones & spawn
   ----------------------------- */
function updateZone(){
  const z = Math.floor((Math.max(1,stage)-1)/50)+1;
  game.classList.remove('zone-1','zone-2','zone-3','zone-4');
  if(z===1) game.classList.add('zone-1');
  else if(z===2) game.classList.add('zone-2');
  else if(z===3) game.classList.add('zone-3');
  else game.classList.add('zone-4');
}

/* -----------------------------
   Spawn monster & boss timer
   ----------------------------- */
let bossTime = 0, bossTimer = null;
function spawnMonster(){
  updateZone();
  const m = randPick(monsterPool);
  isBoss = (stage % 5 === 0);
  const zoneBoost = Math.floor((stage-1)/50);
  const scale = 1 + stage*0.12 + zoneBoost*0.7;
  monsterMaxHP = Math.floor(m.baseHP * scale * (isBoss ? 4 : 1) * MONSTER_HP_SCALE);
  monsterHP = monsterMaxHP;
  monsterAtk = Math.max(1, Math.floor(m.baseAtk * (isBoss ? 1.6 : 1) * (1 + stage * 0.05) * (1+zoneBoost*0.4)));
  monsterEmojiEl.innerText = m.emoji;
  monsterBadgeEl.innerText = (isBoss ? 'üëë' : '') + (zoneBoost ? ' üî•' : '');
  if(isBoss) startBossTimer();
  updateUI();
}
function startBossTimer(){
  clearBossTimer();
  bossTime = 15;
  bossTimer = setInterval(()=>{
    if(mode !== 'adventure') return;
    bossTime--;
    if(bossTime <= 0){ clearBossTimer(); loseAndReset(); showToast('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ö‡∏≠‡∏™‡∏´‡∏ô‡∏µ! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á'); }
    updateUI();
  },1000);
}
function clearBossTimer(){ if(bossTimer){ clearInterval(bossTimer); bossTimer = null; } }

/* -----------------------------
   Attacks & cooldowns
   ----------------------------- */
atkBtn.addEventListener('click', playerAttack);
ultBtn.addEventListener('click', playerUltimate);
healBtn.addEventListener('click', playerHeal);

function faceMonster(){ hero.style.transform='scaleX(1)'; }
function faceNormal(){ hero.style.transform='scaleX(-1)'; }

function playerAttack(){
  if(mode !== 'adventure' || !atkReady || monsterHP <= 0) return;
  atkReady = false; atkBtn.disabled = true;
  faceMonster();
  hero.classList.add('move-attack'); setTimeout(()=>{ hero.classList.remove('move-attack'); faceNormal(); },700);
  const dmg = power;
  showDmgAtMonster(dmg,false);
  monsterHP = Math.max(0, monsterHP - dmg);
  if(isBoss && bossTime>0) bossTime = Math.max(0, bossTime-1);
  if(monsterHP <= 0) onWin();
  setTimeout(()=>{ atkReady = true; atkBtn.disabled = false; },700);
  updateUI();
}

function playerUltimate(){
  if(mode !== 'adventure' || !ultReady || monsterHP <= 0) return;
  ultReady = false; ultBtn.disabled = true;
  faceMonster();
  const dmg = power * 10;
  showDmgAtMonster(dmg,true);
  monsterHP = Math.max(0, monsterHP - dmg);
  if(isBoss && bossTime>0) bossTime = Math.max(0, bossTime-2);
  if(monsterHP <= 0) onWin();
  let cd = 20; ultBtn.innerText = `‡∏≠‡∏±‡∏•‡∏ï‡∏¥ (${cd}s)`;
  const t = setInterval(()=>{ cd--; ultBtn.innerText = `‡∏≠‡∏±‡∏•‡∏ï‡∏¥ (${cd}s)`; if(cd <= 0){ clearInterval(t); ultReady = true; ultBtn.disabled = false; ultBtn.innerText = '‡∏≠‡∏±‡∏•‡∏ï‡∏¥'; } },1000);
  updateUI();
}

function playerHeal(){
  if(mode !== 'adventure' || !healReady) return;
  healReady = false; healBtn.disabled = true;
  const amt = Math.floor(maxHP * 0.25);
  playerHP = Math.min(maxHP, playerHP + amt);
  showDmgAtPlayer('+'+amt,'#7fffd4');
  setTimeout(()=>{ healReady = true; healBtn.disabled = false; },15000);
  updateUI();
}

/* -----------------------------
   Loops: monster attack & pet attacks
   ----------------------------- */
let monsterLoop = null, petLoop = null;
function startLoops(){
  stopLoops();
  // monster attack every 1.5s
  monsterLoop = setInterval(()=>{
    if(mode !== 'adventure' || monsterHP <= 0) return;
    monsterEl.classList.add('move-mattack'); setTimeout(()=>monsterEl.classList.remove('move-mattack'),220);
    const dmg = Math.max(1, monsterAtk);
    playerHP = Math.max(0, playerHP - dmg);
    showDmgAtPlayer('-'+dmg,'#ffd');
    if(playerHP <= 0){
      if(infinityMode) { // end infinity run
        endInfinity();
      } else {
        loseAndReset();
        showToast('‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏¢! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á');
      }
    }
    updateUI();
  },1500);

  // pet attacks every 0.5s
  petLoop = setInterval(()=>{
    if(mode !== 'adventure' || monsterHP <= 0) return;
    for(let slotIndex=0; slotIndex<active.length; slotIndex++){
      const idx = active[slotIndex];
      if(idx == null) continue;
      const p = bag[idx];
      if(!p) continue;
      const dmg = Math.max(0, Math.floor(power * p.pct * (1 + (p.lvl-1)*0.12)));
      animatePetAttack(slotIndex);
      showDmgAtMonster(dmg,false,true);
      monsterHP = Math.max(0, monsterHP - dmg);
      if(isBoss && bossTime>0) bossTime = Math.max(0, bossTime-1);
      if(monsterHP <= 0){
        if(infinityMode){
          // increment wave and spawn next
          infinityWave++;
          if(infinityWave > bestWave) bestWave = infinityWave;
          stage++;
          spawnMonster();
          // continue loop
        } else {
          onWin();
        }
        break;
      }
    }
    updateUI();
  },500);
}

function stopLoops(){ if(monsterLoop){ clearInterval(monsterLoop); monsterLoop=null; } if(petLoop){ clearInterval(petLoop); petLoop=null; } clearBossTimer(); }

/* -----------------------------
   Regen
   ----------------------------- */
let regenTimer = null;
function startRegen(){
  stopRegen();
  regenTimer = setInterval(()=>{
    if(mode !== 'adventure') return;
    const heal = Math.floor(maxHP * 0.10);
    if(playerHP < maxHP){
      playerHP = Math.min(maxHP, playerHP + heal);
      showDmgAtPlayer('+'+heal,'#7fffd4');
      updateUI();
    }
  },5000);
}
function stopRegen(){ if(regenTimer){ clearInterval(regenTimer); regenTimer=null; } }

/* -----------------------------
   Win / Lose / Infinity end
   ----------------------------- */
function onWin(){
  // Infinity behaviour handled in loops; normal onWin:
  if(infinityMode){
    // handled in pet loop to continue waves
    return;
  }
  stopLoops(); stopRegen();
  const reward = isBoss ? Math.floor(stage * BOSS_REWARD_MULT * rebirthMultiplier) : Math.floor(stage * NORMAL_REWARD_MULT * rebirthMultiplier);
  gold += reward;
  playerHP = maxHP;
  winBox.innerHTML = `
    üéâ ‡∏ä‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß!<br>
    ‡πÄ‡∏á‡∏¥‡∏ô +${formatNumber(reward)}<div style="margin-top:10px" class="small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏Å‡∏•‡∏±‡∏ö Lobby ‡∏´‡∏£‡∏∑‡∏≠ ‡∏™‡∏π‡πâ‡∏ï‡πà‡∏≠</div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
      <button id="btnToLobby" class="shop">‡∏Å‡∏•‡∏±‡∏ö Lobby</button>
      <button id="btnContinue" class="shop">‡∏™‡∏π‡πâ‡∏ï‡πà‡∏≠</button>
    </div>
  `;
  winBox.style.display = 'block';
  updateUI();
  document.getElementById('btnToLobby').addEventListener('click', ()=>{ winBox.style.display='none'; enterLobby(); });
  document.getElementById('btnContinue').addEventListener('click', ()=>{ winBox.style.display='none'; stage++; spawnMonster(); startLoops(); startRegen(); updateUI(); });
}

function loseAndReset(){
  bag = []; active = new Array(2).fill(null); activeSlots = 2;
  petSlotPrice = 50000;
  gold = 20; power = 5; maxHP = 120; playerHP = maxHP; stage = 0;
  mode = 'lobby';
  stopLoops(); stopRegen(); clearBossTimer();
  monsterEmojiEl.innerText = ''; monsterBadgeEl.innerText = '';
  monsterMaxHP = 0; monsterHP = 0; isBoss = false;
  updateUI();
  showToast('‡πÅ‡∏û‡πâ! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á');
}

function endInfinity(){
  // called when player dies in infinity or surrenders
  const payout = Math.floor(infinityWave * 10 * (rebirthMultiplier || 1));
  gold += payout;
  if(infinityWave > bestWave) bestWave = infinityWave;
  showToast(`‡∏à‡∏ö Infinity! ‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô ${formatNumber(payout)} (‡πÄ‡∏ß‡∏ü ${infinityWave})`);
  infinityMode = false; infinityWave = 0;
  surrenderBtn.style.display = 'none';
  enterLobby();
  updateUI();
}

/* -----------------------------
   Damage visuals (fixed to position over monster/player)
   ----------------------------- */
function showDmgAtMonster(n,isCrit=false,fromPet=false){
  try{
    const rect = monsterEl.getBoundingClientRect();
    const gameRect = game.getBoundingClientRect();
    const el = document.createElement('div'); el.className = 'dmg';
    el.innerText = (isCrit ? 'CRIT '+n : n);
    el.style.left = (rect.left + rect.width/2 - gameRect.left - 20) + 'px';
    el.style.top = (rect.top - gameRect.top - 10) + 'px';
    game.appendChild(el);
    setTimeout(()=>el.remove(),900);
  }catch(e){ console.error('showDmgAtMonster error', e); }
}
function showDmgAtPlayer(txt,color='#ffd'){
  try{
    const rect = hero.getBoundingClientRect();
    const gameRect = game.getBoundingClientRect();
    const el = document.createElement('div'); el.className = 'dmg';
    el.style.color = color; el.innerText = txt;
    el.style.left = (rect.left - gameRect.left + 30) + 'px';
    el.style.top = (rect.top - gameRect.top - 10) + 'px';
    game.appendChild(el);
    setTimeout(()=>el.remove(),900);
  }catch(e){ console.error('showDmgAtPlayer error', e); }
}

/* -----------------------------
   Pet sprites & animations (above hero)
   ----------------------------- */
function renderActiveSprites(){
  const old = game.querySelectorAll('.pet-sprite');
  old.forEach(o=>o.remove());
  if(mode !== 'adventure') return;
  const heroBottom = parseInt(getComputedStyle(hero).bottom) || 22;
  for(let i=0;i<activeSlots;i++){
    const idx = active[i];
    const el = document.createElement('div');
    el.className = 'pet-sprite';
    el.style.left = (hero.offsetLeft + 40 + i*34) + 'px';
    el.style.bottom = (heroBottom + 80) + 'px';
    el.innerText = idx != null && bag[idx] ? bag[idx].emoji : '';
    game.appendChild(el);
  }
}
function animatePetAttack(slotIndex){
  const sprites = game.querySelectorAll('.pet-sprite');
  const s = sprites[slotIndex];
  if(!s) return;
  s.classList.remove('pet-attack');
  void s.offsetWidth;
  s.classList.add('pet-attack');
}

/* -----------------------------
   Upgrades: bulk & cost (simple incremental)
   ----------------------------- */
buyPowerBtn.addEventListener('click', ()=> buyPower(1));
buyPower10Btn.addEventListener('click', ()=> buyPower(10));
buyPower100Btn.addEventListener('click', ()=> buyPower(100));
buyPower1000Btn.addEventListener('click', ()=> buyPower(1000));
buyPower10000Btn.addEventListener('click', ()=> buyPower(10000));

function buyPower(n){
  if(mode !== 'lobby'){ showToast('‡∏≠‡∏±‡∏û‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà Lobby ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
  const costPer = 10;
  let can = Math.floor(gold / costPer);
  if(can === 0){ showToast('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
  if(n > can) n = can;
  gold -= costPer * n;
  power += n;
  showToast(`‡∏≠‡∏±‡∏û‡∏û‡∏•‡∏±‡∏á x${n}`);
  updateUI();
}

buyHPBtn.addEventListener('click', ()=> buyHP(1));
buyHP10Btn.addEventListener('click', ()=> buyHP(10));
buyHP100Btn.addEventListener('click', ()=> buyHP(100));

function buyHP(n){
  if(mode !== 'lobby'){ showToast('‡∏≠‡∏±‡∏û‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà Lobby ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
  const costPer = 15;
  let can = Math.floor(gold / costPer);
  if(can === 0){ showToast('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
  if(n > can) n = can;
  gold -= costPer * n;
  maxHP += 20 * n;
  playerHP = maxHP;
  showToast(`‡∏≠‡∏±‡∏û‡πÄ‡∏•‡∏∑‡∏≠‡∏î x${n}`);
  updateUI();
}

/* -----------------------------
   Buy pet slot (max 4)
   ----------------------------- */
buyPetSlotBtn.addEventListener('click', ()=>{
  if(mode !== 'lobby'){ showToast('‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà Lobby ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'); return; }
  if(activeSlots >= maxActiveSlots){ showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß'); return; }
  if(gold < petSlotPrice){ showToast('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
  gold -= petSlotPrice;
  petSlotPrice += petSlotIncrement;
  activeSlots++;
  active = active.concat(new Array(1).fill(null));
  showToast('‡∏ã‡∏∑‡πâ‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  updateUI();
});

/* -----------------------------
   Auto-sell commons / epics
   ----------------------------- */
autoSellBtn.addEventListener('click', ()=>{
  if(bag.length === 0){ showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ï‡∏ß‡πå'); return; }
  let sold = 0, income = 0;
  for(let i = bag.length - 1; i >= 0; i--){
    if(bag[i].tier === 'Common'){
      income += bag[i].price;
      sold++;
      bag.splice(i,1);
    }
  }
  gold += income;
  showToast(`‡∏Ç‡∏≤‡∏¢ ${sold} ‡∏ï‡∏±‡∏ß ‡∏£‡∏±‡∏ö ${formatNumber(income)}`);
  updateUI();
});

autoSellEpicBtn.addEventListener('click', ()=>{
  if(bag.length === 0){ showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ï‡∏ß‡πå'); return; }
  let sold = 0, income = 0;
  for(let i = bag.length - 1; i >= 0; i--){
    if(bag[i].tier === 'Epic'){
      income += bag[i].price;
      sold++;
      bag.splice(i,1);
    }
  }
  gold += income;
  showToast(`‡∏Ç‡∏≤‡∏¢ ${sold} ‡∏ï‡∏±‡∏ß Epic ‡∏£‡∏±‡∏ö ${formatNumber(income)}`);
  updateUI();
});

/* -----------------------------
   Rebirth (keep bag, eggsOpened, bestWave; reset active & stats)
   ----------------------------- */
rebirthBtn.addEventListener('click', ()=>{
  if(!currentPlayerCode){ showToast('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); openAuth(); return; }
  if(gold < rebirthCost){ showToast('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Rebirth'); return; }
  if(!confirm(`Rebirth ‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏•‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏±‡∏ï‡∏ß‡πå, ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏Ç‡πà ‡πÅ‡∏•‡∏∞ Best Wave ‡πÑ‡∏ß‡πâ\n‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: ${formatNumber(rebirthCost)}\n‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

  gold -= rebirthCost;
  rebirthCount++;
  rebirthMultiplier *= 2;
  rebirthCost = Math.ceil(rebirthCost * 1.7);

  // Keep bag, eggsOpened, bestWave
  // Reset active & player stats
  active = new Array(2).fill(null);
  activeSlots = 2;
  petSlotPrice = 50000;

  power = 5;
  maxHP = 120;
  playerHP = maxHP;
  stage = 0;

  saveGame(); updateUI();
  showToast('Rebirth ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà: ' + rebirthCount + ' ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì x' + rebirthMultiplier);
});

/* -----------------------------
   Infinity Mode (from Lobby)
   ----------------------------- */
infinityBtn.addEventListener('click', ()=>{
  if(!currentPlayerCode){ showToast('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); openAuth(); return; }
  if(mode !== 'lobby'){ showToast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Lobby ‡∏Å‡πà‡∏≠‡∏ô'); return; }
  if(!confirm('‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î Infinity? ‡∏°‡∏≠‡∏ô‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏ü ‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏ü')) return;
  infinityMode = true; infinityWave = 0; mode = 'adventure'; stage = 1; spawnMonster(); startLoops(); startRegen(); updateUI(); surrenderBtn.style.display = 'inline-block';
});

surrenderBtn.addEventListener('click', ()=>{
  if(!infinityMode) return;
  if(confirm('‡∏¢‡∏≠‡∏°‡πÅ‡∏û‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏ü‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ?')){
    const payout = Math.floor(infinityWave * 10 * (rebirthMultiplier || 1));
    gold += payout;
    if(infinityWave > bestWave) bestWave = infinityWave;
    infinityMode = false; surrenderBtn.style.display = 'none';
    showToast(`‡∏à‡∏ö Infinity! ‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô ${formatNumber(payout)} (‡πÄ‡∏ß‡∏ü ${infinityWave})`);
    enterLobby(); updateUI();
  }
});

/* -----------------------------
   Expose egg functions for inline onclicks
   ----------------------------- */
window.buyEggs = buyEggs;
window.skipEggs = skipEggs;
window.closeEggModal = closeEggModal;

/* -----------------------------
   Auth (register & login) - NO auto-login
   ----------------------------- */
function openAuth(){ authModal.style.display = 'flex'; authCodeInput.value = ''; authCodeInput.focus(); }
authLoginBtn.addEventListener('click', ()=>{
  const code = (authCodeInput.value || '').trim();
  if(!code){ alert('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô'); return; }
  if(!loadGame(code)){
    if(!confirm('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
    currentPlayerCode = code;
    bag = []; activeSlots = 2; active = new Array(activeSlots).fill(null);
    gold = 20; power = 5; maxHP = 120; playerHP = maxHP; stage = 0; eggsOpened = 0; petSlotPrice = 50000;
    saveGame();
  } else {
    currentPlayerCode = code;
  }
  localStorage.setItem('emoji_lastcode', code);
  authModal.style.display = 'none';
  showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ' + code);
  updateUI();
});
authRegisterBtn.addEventListener('click', ()=>{
  const code = (authCodeInput.value || '').trim();
  if(!code){ alert('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô'); return; }
  if(localStorage.getItem(saveKey(code))){
    if(!confirm('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
  }
  currentPlayerCode = code;
  bag = []; activeSlots = 2; active = new Array(activeSlots).fill(null);
  gold = 20; power = 5; maxHP = 120; playerHP = maxHP; stage = 0; eggsOpened = 0; petSlotPrice = 50000; rebirthCount = 0; rebirthMultiplier = 1; rebirthCost = 1000000; bestWave = 0;
  saveGame();
  localStorage.setItem('emoji_lastcode', code);
  authModal.style.display = 'none';
  showToast('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ' + code);
  updateUI();
});
const logoutBtn = document.getElementById('logoutBtn');
logoutBtn.addEventListener('click', ()=>{
  if(!currentPlayerCode) return;
  if(confirm('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö? (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)')){
    currentPlayerCode = null;
    playerCodeLabel.innerText = '-';
    openAuth();
  }
});

/* -----------------------------
   Init
   ----------------------------- */
function init(){
  // DO NOT auto-login; force user to login/register
  openAuth();
  updateUI();
}
init();

/* -----------------------------
   Window resize
   ----------------------------- */
window.addEventListener('resize', renderActiveSprites);

}); // DOMContentLoaded
</script>
</body>
</html>